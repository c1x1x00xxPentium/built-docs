<!DOCTYPE html>
<html lang="en-us">
  <head>
    
<meta charset="UTF-8">
<title>Secure communication with APM agents | Elastic Observability [master] | Elastic</title>
<meta class="elastic" name="content" content="Secure communication with APM agents | Elastic Observability [master]">

<link rel="home" href="index.html" title="Elastic Observability [master]"/>
<link rel="up" href="securing-apm-server.html" title="Secure communication with the Elastic Stack"/>
<link rel="prev" href="securing-apm-server.html" title="Secure communication with the Elastic Stack"/>
<link rel="next" href="secure-comms-stack.html" title="Secure communication with the Elastic Stack"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Observability"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Observability/Guide/master"/>
<meta name="DC.subject" content="Observability"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.optimizely.com/js/18132920325.js"></script>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Elastic">
    <meta name="application-name" content="Elastic">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <meta name="naver-site-verification" content="936882c1853b701b3cef3721758d80535413dbfd" />
    <meta name="yandex-verification" content="d8a47e95d0972434" />
    <meta name="localized" content="true" />
    <meta name="st:robots" content="follow,index" />
    <meta property="og:image" content="https://static-www.elastic.co/v3/assets/bltefdd0b53724fa2ce/blt280217a63b82a734/6202d3378b1f312528798412/elastic-logo.svg" />
    <meta property="og:image:width" content="500" />
    <meta property="og:image:height" content="172" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon-precomposed" sizes="64x64" href="/favicon_64x64_16bit.png">
    <link rel="apple-touch-icon-precomposed" sizes="32x32" href="/favicon_32x32.png">
    <link rel="apple-touch-icon-precomposed" sizes="16x16" href="/favicon_16x16.png">
    <!-- Give IE8 a fighting chance -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="/guide/static/styles.css" />
  </head>

  <!--© 2015-2022 Elasticsearch B.V. -->
  <!-- All Elastic documentation is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License. -->
  <!-- http://creativecommons.org/licenses/by-nc-nd/4.0/ -->

  <body>
    <!-- Google Tag Manager -->
    <script>dataLayer = [];</script><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-58RLH5" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-58RLH5');</script>
    <!-- End Google Tag Manager -->

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-16"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-12395217-16');
    </script>

    <!-- Google Tag Manager for GA4 -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KNJMG2M');</script>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KNJMG2M" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager for GA4-->

    <div id='elastic-nav' style="display:none;"></div>
    <script src='https://www.elastic.co/elastic-nav.js'></script>

    <div class="main-container">
      <section id="content" >
        <div class="content-wrapper">

          <section id="guide" lang="en">
            <div class="container-fluid">
              <div class="row pb-3">
                <div class="col-12 order-2 col-md-4 order-md-1 col-lg-3 h-almost-full-md sticky-top-md" id="left_col">
                  <!-- The TOC is appended here -->
                </div>

                <div class="col-12 order-1 col-md-8 order-md-2 col-lg-7 order-lg-2 guide-section" id="middle_col">
                  <!-- start body -->
                  <div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elastic Observability [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="apm.html">Application performance monitoring (APM)</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="securing-apm-server.html">Secure communication with the Elastic Stack</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="securing-apm-server.html">« Secure communication with the Elastic Stack</a>
</span>
<span class="next">
<a href="secure-comms-stack.html">Secure communication with the Elastic Stack »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="secure-agent-communication"></a>Secure communication with APM agents<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/apm-server/secure-agent-communication.asciidoc">edit</a></h3>
</div></div></div>

<p>Communication between APM agents and Elastic Agent can be both encrypted and authenticated.
It is strongly recommended to use both TLS encryption and authentication as secrets are sent as plain text.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="secure-agent-communication.html#agent-tls" title="APM agent TLS communication">TLS encryption</a>
</li>
<li class="listitem">
<a class="xref" href="secure-agent-communication.html#api-key" title="API keys">API key authentication</a>
</li>
<li class="listitem">
<a class="xref" href="secure-agent-communication.html#secret-token" title="Secret token">Secret token authentication</a>
</li>
</ul>
</div>
<p>As soon as an authenticated communication is enabled,
requests without a valid token or API key will be denied.
If both API keys and a secret token are enabled, APM agents can choose whichever mechanism they support.</p>
<p>In some use-cases, like when an APM agent is running on the client side,
authentication is not possible. See <a class="xref" href="secure-agent-communication.html#anonymous-auth" title="Anonymous authentication">Anonymous authentication</a> for more information.</p>
<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="agent-tls"></a>APM agent TLS communication<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/apm-server/tls-comms.asciidoc">edit</a></h4>
</div></div></div>
<p>TLS is disabled by default.
When TLS is enabled for APM Server inbound communication, agents will verify the identity
of the APM Server by authenticating its certificate.</p>
<p>When TLS is enabled, a certificate and corresponding private key are required.
The certificate and private key can either be issued by a trusted certificate authority (CA)
or be <a class="xref" href="secure-agent-communication.html#agent-self-sign" title="Use a self-signed certificate">self-signed</a>.</p>
<h5><a id="agent-self-sign"></a>Use a self-signed certificate<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/apm-server/tls-comms.asciidoc">edit</a></h5>
<h6><a id="agent-self-sign-1"></a>Step 1: Create a self-signed certificate<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/apm-server/tls-comms.asciidoc">edit</a></h6>
<p>The Elasticsearch distribution offers the <code class="literal">certutil</code> tool for the creation of self-signed certificates:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Create a CA: <code class="literal">./bin/elasticsearch-certutil ca --pem</code>. You&#8217;ll be prompted to enter the desired
location of the output zip archive containing the certificate and the private key.
</li>
<li class="listitem">
Extract the contents of the CA archive.
</li>
<li class="listitem">
Create the self-signed certificate: <code class="literal">./bin/elasticsearch-certutil cert --ca-cert
&lt;path-to-ca-crt&gt;/ca.crt --ca-key &lt;path-to-ca-key&gt;/ca.key --pem --name localhost</code>
</li>
<li class="listitem">
Extract the certificate and key from the resulted zip archive.
</li>
</ol>
</div>
<h6><a id="agent-self-sign-2"></a>Step 2: Configure the APM Server<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/apm-server/tls-comms.asciidoc">edit</a></h6>
<p>Enable TLS and configure the APM Server to point to the extracted certificate and key:</p>
<div class="tabs" data-tab-group="ts">
  <div role="tablist" aria-label="tls">
    <button role="tab"
            aria-selected="true"
            aria-controls="fm-tab-ts"
            id="fm-ts">
      Fleet-managed
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="binary-tab-ts"
            id="binary-ts"
            tabindex="-1">
      APM Server binary
    </button>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="fm-tab-ts"
       aria-labelledby="fm-ts">
<p>Enable TLS in the APM integration settings and use the <a class="xref" href="configuration-ssl-landing.html#agent-server-ssl" title="SSL/TLS input settings">SSL/TLS input settings</a> to set the path to the server certificate and key.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="binary-tab-ts"
       aria-labelledby="binary-ts"
       hidden="">
<p>The following is a basic APM Server SSL config with secure communication enabled.
This will make APM Server serve HTTPS requests instead of HTTP.</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">apm-server.ssl.enabled: true
apm-server.ssl.certificate: "/path/to/apm-server.crt"
apm-server.ssl.key: "/path/to/apm-server.key"</pre>
</div>
<p>A full list of configuration options is available in <a class="xref" href="configuration-ssl-landing.html#agent-server-ssl" title="SSL/TLS input settings">SSL/TLS input settings</a>.</p>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p>If APM agents are authenticating themselves using a certificate that cannot be authenticated through known CAs (e.g. self signed certificates), use the <code class="literal">ssl.certificate_authorities</code> to set a custom CA.
This will automatically modify the <code class="literal">ssl.client_authentication</code> configuration to require authentication.</p>
</div>
</div>
  </div>
</div>
<h6><a id="agent-self-sign-3"></a>Step 3: Configure APM agents<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/apm-server/tls-comms.asciidoc">edit</a></h6>
<p>When the APM server uses a certificate that is not chained to a publicly-trusted certificate
(e.g. self-signed), additional configuration is required in the APM agent:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Go agent</strong></span>: certificate pinning through <a href="/guide/en/apm/agent/go/current/configuration.html#config-server-cert" class="ulink" target="_top"><code class="literal">ELASTIC_APM_SERVER_CERT</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>Python agent</strong></span>: certificate pinning through <a href="/guide/en/apm/agent/python/current/configuration.html#config-server-cert" class="ulink" target="_top"><code class="literal">server_cert</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>Ruby agent</strong></span>: certificate pinning through <a href="/guide/en/apm/agent/ruby/current/configuration.html#config-ssl-ca-cert" class="ulink" target="_top"><code class="literal">server_ca_cert</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>.NET agent</strong></span>: <a href="/guide/en/apm/agent/dotnet/current/config-reporter.html#config-server-cert" class="ulink" target="_top"><code class="literal">ServerCert</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>Node.js agent</strong></span>: custom CA setting through <a href="/guide/en/apm/agent/nodejs/current/configuration.html#server-ca-cert-file" class="ulink" target="_top"><code class="literal">serverCaCertFile</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>Java agent</strong></span>: adding the certificate to the JVM <code class="literal">trustStore</code>.
See <a href="/guide/en/apm/agent/java/current/ssl-configuration.html#ssl-server-authentication" class="ulink" target="_top">APM Server authentication</a> for more details.
</li>
</ul>
</div>
<p>We do not recommend disabling APM agent verification of the server&#8217;s certificate, but it is possible:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Go agent</strong></span>: <a href="/guide/en/apm/agent/go/current/configuration.html#config-verify-server-cert" class="ulink" target="_top"><code class="literal">ELASTIC_APM_VERIFY_SERVER_CERT</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>.NET agent</strong></span>: <a href="/guide/en/apm/agent/dotnet/current/config-reporter.html#config-verify-server-cert" class="ulink" target="_top"><code class="literal">VerifyServerCert</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>Java agent</strong></span>: <a href="/guide/en/apm/agent/java/current/config-reporter.html#config-verify-server-cert" class="ulink" target="_top"><code class="literal">verify_server_cert</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>PHP agent</strong></span>: <a href="/guide/en/apm/agent/php/1.x/configuration-reference.html#config-verify-server-cert" class="ulink" target="_top"><code class="literal">verify_server_cert</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>Python agent</strong></span>: <a href="/guide/en/apm/agent/python/current/configuration.html#config-verify-server-cert" class="ulink" target="_top"><code class="literal">verify_server_cert</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>Ruby agent</strong></span>: <a href="/guide/en/apm/agent/ruby/current/configuration.html#config-verify-server-cert" class="ulink" target="_top"><code class="literal">verify_server_cert</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>Node.js agent</strong></span>: <a href="/guide/en/apm/agent/nodejs/current/configuration.html#validate-server-cert" class="ulink" target="_top"><code class="literal">verifyServerCert</code></a>
</li>
</ul>
</div>
<h5><a id="agent-client-cert"></a>Client certificate authentication<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/apm-server/tls-comms.asciidoc">edit</a></h5>
<p>APM Server does not require agents to provide a certificate for authentication,
and there is no dedicated support for SSL/TLS client certificate authentication in Elastic’s backend agents.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="api-key"></a>API keys<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/apm-server/api-keys.asciidoc">edit</a></h4>
</div></div></div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>API keys are sent as plain-text,
so they only provide security when used in combination with <a class="xref" href="secure-agent-communication.html#agent-tls" title="APM agent TLS communication">TLS</a>.</p>
</div>
</div>
<p>When enabled, API keys are used to authorize requests to the APM Server.
API keys are not applicable for APM agents running on clients, like the RUM agent,
as there is no way to prevent them from being publicly exposed.</p>
<p>You can assign one or more unique privileges to each API key:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Agent configuration</strong></span> (<code class="literal">config_agent:read</code>): Required for agents to read
<a href="/guide/en/kibana/master/agent-configuration.html" class="ulink" target="_top">Agent configuration remotely</a>.
</li>
<li class="listitem">
<span class="strong strong"><strong>Ingest</strong></span> (<code class="literal">event:write</code>): Required for ingesting agent events.
</li>
</ul>
</div>
<p>To secure the communication between APM Agents and the APM Server with API keys,
make sure <a class="xref" href="secure-agent-communication.html#agent-tls" title="APM agent TLS communication">TLS</a> is enabled, then complete these steps:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<a class="xref" href="secure-agent-communication.html#enable-api-key" title="Enable API keys">Enable API keys</a>
</li>
<li class="listitem">
<a class="xref" href="secure-agent-communication.html#create-api-key-user" title="Create an API key user in Kibana">Create an API key user</a>
</li>
<li class="listitem">
<a class="xref" href="secure-agent-communication.html#create-an-api-key" title="Create an API key in the APM app">Create an API key in Kibana</a>
</li>
<li class="listitem">
<a class="xref" href="secure-agent-communication.html#agent-api-key" title="Set the API key in your APM agents">Set the API key in your APM agents</a>
</li>
</ol>
</div>
<h5><a id="enable-api-key"></a>Enable API keys<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/apm-server/api-keys.asciidoc">edit</a></h5>
<div class="tabs" data-tab-group="ts">
  <div role="tablist" aria-label="tls">
    <button role="tab"
            aria-selected="true"
            aria-controls="fm-tab-ts"
            id="fm-ts">
      Fleet-managed
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="binary-tab-ts"
            id="binary-ts"
            tabindex="-1">
      APM Server binary
    </button>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="fm-tab-ts"
       aria-labelledby="fm-ts">
<p>Enable API key authorization in the <a class="xref" href="apm-agent-auth.html#api-key-auth-settings" title="API key authentication options">API key authentication options</a>.
You should also set a limit on the number of unique API keys that APM Server allows per minute;
this value should be the number of unique API keys configured in your monitored services.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="binary-tab-ts"
       aria-labelledby="binary-ts"
       hidden="">
<p>API keys are disabled by default. Enable and configure this feature in the <code class="literal">apm-server.auth.api_key</code>
section of the <code class="literal">apm-server.yml</code> configuration file.</p>
<p>At a minimum, you must enable API keys,
and should set a limit on the number of unique API keys that APM Server allows per minute.
Here&#8217;s an example <code class="literal">apm-server.auth.api_key</code> config using 50 unique API keys:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">apm-server.auth.api_key.enabled: true <a id="CO42-1"></a><i class="conum" data-value="1"></i>
apm-server.auth.api_key.limit: 50 <a id="CO42-2"></a><i class="conum" data-value="2"></i></pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO42-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>Enables API keys</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO42-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>Restricts the number of unique API keys that Elasticsearch allows each minute.
This value should be the number of unique API keys configured in your monitored services.</p>
</td>
</tr>
</table>
</div>
<p>All other configuration options are described in <a class="xref" href="secure-agent-communication.html#api-key" title="API keys">API keys</a>.</p>
  </div>
</div>
<h5><a id="create-api-key-user"></a>Create an API key user in Kibana<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/apm-server/api-keys.asciidoc">edit</a></h5>
<p>API keys can only have the same or lower access rights than the user that creates them.
Instead of using a superuser account to create API keys, you can create a role with the minimum required
privileges.</p>
<p>The user creating an APM agent API key must have at least the <code class="literal">manage_own_api_key</code> cluster privilege
and the APM application-level privileges that it wishes to grant.
In addition, when creating an API key from the APM app,
you&#8217;ll need the appropriate Kibana Space and Feature privileges.</p>
<p>The example below uses the Kibana <a href="/guide/en/kibana/master/role-management-api.html" class="ulink" target="_top">role management API</a>
to create a role named <code class="literal">apm_agent_key_role</code>.</p>
<div class="pre_wrapper lang-js">
<pre class="programlisting prettyprint lang-js">POST /_security/role/apm_agent_key_role
{
   "cluster": [ "manage_own_api_key" ],
   "applications": [
      {
         "application":"apm",
         "privileges":[
            "event:write",
            "config_agent:read"
         ],
         "resources":[ "*" ]
      },
      {
         "application":"kibana-.kibana",
         "privileges":[ "feature_apm.all" ],
         "resources":[ "space:default" ] <a id="CO43-1"></a><i class="conum" data-value="1"></i>
      }
   ]
}</pre>
</div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO43-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>This example assigns privileges for the default space.</p>
</td>
</tr>
</table>
</div>
<p>Assign the newly created <code class="literal">apm_agent_key_role</code> role to any user that wishes to create APM agent API keys.</p>
<h5><a id="create-an-api-key"></a>Create an API key in the APM app<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/apm-server/api-keys.asciidoc">edit</a></h5>
<p>The APM app has a built-in workflow that you can use to easily create and view APM agent API keys.
Only API keys created in the APM app will show up here.</p>
<p>Using a superuser account, or a user with the role created in the previous step,
open Kibana and navigate to <span class="strong strong"><strong>Observability</strong></span> &gt; <span class="strong strong"><strong>APM</strong></span> &gt; <span class="strong strong"><strong>Settings</strong></span> &gt; <span class="strong strong"><strong>Agent keys</strong></span>.
Enter a name for your API key and select at least one privilege.</p>
<p>For example, to create an API key that can be used to ingest APM events
and read agent central configuration, select <code class="literal">config_agent:read</code> and <code class="literal">event:write</code>.</p>
<p>Click <span class="strong strong"><strong>Create APM Agent key</strong></span> and copy the Base64 encoded API key.
You will need this for the next step, and you will not be able to view it again.</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/apm-ui-api-key.png" alt="APM app API key">
</div>
</div>
<h5><a id="agent-api-key"></a>Set the API key in your APM agents<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/apm-server/api-keys.asciidoc">edit</a></h5>
<p>You can now apply your newly created API keys in the configuration of each of your APM agents.
See the relevant agent documentation for additional information:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Go agent</strong></span>: <a href="/guide/en/apm/agent/go/current/configuration.html#config-api-key" class="ulink" target="_top"><code class="literal">ELASTIC_APM_API_KEY</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>.NET agent</strong></span>: <a href="/guide/en/apm/agent/dotnet/current/config-reporter.html#config-api-key" class="ulink" target="_top"><code class="literal">ApiKey</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>Java agent</strong></span>: <a href="/guide/en/apm/agent/java/current/config-reporter.html#config-api-key" class="ulink" target="_top"><code class="literal">api_key</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>Node.js agent</strong></span>: <a href="/guide/en/apm/agent/nodejs/current/configuration.html#api-key" class="ulink" target="_top"><code class="literal">apiKey</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>PHP agent</strong></span>: <a href="/guide/en/apm/agent/php/1.x/configuration-reference.html#config-api-key" class="ulink" target="_top"><code class="literal">api_key</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>Python agent</strong></span>: <a href="/guide/en/apm/agent/python/current/configuration.html#config-api-key" class="ulink" target="_top"><code class="literal">api_key</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>Ruby agent</strong></span>: <a href="/guide/en/apm/agent/ruby/current/configuration.html#config-api-key" class="ulink" target="_top"><code class="literal">api_key</code></a>
</li>
</ul>
</div>
<h5><a id="configure-api-key-alternative"></a>Alternate API key creation methods<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/apm-server/api-keys.asciidoc">edit</a></h5>
<p>API keys can also be created and validated outside of Kibana:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="secure-agent-communication.html#create-api-key-workflow-apm-server" title="APM Server API key workflow">APM Server API key workflow</a>
</li>
<li class="listitem">
<a class="xref" href="secure-agent-communication.html#create-api-key-workflow-es" title="Elasticsearch API key workflow">Elasticsearch API key workflow</a>
</li>
</ul>
</div>
<h6><a id="create-api-key-workflow-apm-server"></a>APM Server API key workflow<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/apm-server/api-keys.asciidoc">edit</a></h6>
<p>This API creation method only works with the APM Server binary.</p>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<h3>Deprecated in 8.6.0.</h3>
<p>Users should create API Keys through Kibana or the Elasticsearch REST API</p>
</div>
</div>
<p>APM Server provides a command line interface for creating, retrieving, invalidating, and verifying API keys.
Keys created using this method can only be used for communication with APM Server.</p>
<h7><a id="create-api-key-subcommands"></a><code class="literal">apikey</code> subcommands<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/apm-server/api-keys.asciidoc">edit</a></h7>
<div class="variablelist">
<dl class="variablelist">
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">create</code></strong></span>
</span>
</dt>
<dd>
<p>
Create an API Key with the specified privilege(s). No required flags.
</p>
<p>The user requesting to create an API Key needs to have APM privileges used by the APM Server.
A superuser, by default, has these privileges. For other users,
you can create them. See <a class="xref" href="secure-comms-stack.html#privileges-api-key" title="Grant privileges and roles needed for API key management">create an API key user</a> for required privileges.</p>
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">info</code></strong></span>
</span>
</dt>
<dd>
Query API Key(s). <code class="literal">--id</code> or <code class="literal">--name</code> required.
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">invalidate</code></strong></span>
</span>
</dt>
<dd>
Invalidate API Key(s). <code class="literal">--id</code> or <code class="literal">--name</code> required.
</dd>
<dt>
<span class="term">
<span class="strong strong"><strong><code class="literal">verify</code></strong></span>
</span>
</dt>
<dd>
Check if a credentials string has the given privilege(s).
 <code class="literal">--credentials</code> required.
</dd>
</dl>
</div>
<h7><a id="create-api-key-privileges"></a>Privileges<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/apm-server/api-keys.asciidoc">edit</a></h7>
<p>If privileges are not specified at creation time, the created key will have all privileges.</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">--agent-config</code> grants the <code class="literal">config_agent:read</code> privilege
</li>
<li class="listitem">
<code class="literal">--ingest</code> grants the <code class="literal">event:write</code> privilege
</li>
<li class="listitem">
<code class="literal">--sourcemap</code> grants the <code class="literal">sourcemap:write</code> privilege
</li>
</ul>
</div>
<h7><a id="create-api-key-workflow"></a>Create an API key<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/apm-server/api-keys.asciidoc">edit</a></h7>
<p>Create an API key with the <code class="literal">create</code> subcommand.</p>
<p>The following example creates an API key with a <code class="literal">name</code> of <code class="literal">java-001</code>,
and gives the "agent configuration" and "ingest" privileges.</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">apm-server apikey create --ingest --agent-config --name java-001</pre>
</div>
<p>The response will look similar to this:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">Name ........... java-001
Expiration ..... never
Id ............. qT4tz28B1g59zC3uAXfW
API Key ........ rH55zKd5QT6wvs3UbbkxOA (won't be shown again)
Credentials .... cVQ0dHoyOEIxZzU5ekMzdUFYZlc6ckg1NXpLZDVRVDZ3dnMzVWJia3hPQQ== (won't be shown again)</pre>
</div>
<p>You should always verify the privileges of an API key after creating it.
Verification can be done using the <code class="literal">verify</code> subcommand.</p>
<p>The following example verifies that the <code class="literal">java-001</code> API key has the "agent configuration" and "ingest" privileges.</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">apm-server apikey verify --agent-config --ingest --credentials cVQ0dHoyOEIxZzU5ekMzdUFYZlc6ckg1NXpLZDVRVDZ3dnMzVWJia3hPQQ==</pre>
</div>
<p>If the API key has the requested privileges, the response will look similar to this:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">Authorized for privilege "event:write"...:          Yes
Authorized for privilege "config_agent:read"...:    Yes</pre>
</div>
<p>To invalidate an API key, use the <code class="literal">invalidate</code> subcommand.
Due to Elasticsearch caching, there may be a delay between when this subcommand is executed and when it takes effect.</p>
<p>The following example invalidates the <code class="literal">java-001</code> API key.</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">apm-server apikey invalidate --name java-001</pre>
</div>
<p>The response will look similar to this:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">Invalidated keys ... qT4tz28B1g59zC3uAXfW
Error count ........ 0</pre>
</div>
<p>A full list of <code class="literal">apikey</code> subcommands and flags is available in the <a class="xref" href="command-line-options.html#apikey-command" title="apikey command">API key command reference</a>.</p>
<h6><a id="create-api-key-workflow-es"></a>Elasticsearch API key workflow<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/apm-server/api-keys.asciidoc">edit</a></h6>
<p>It is also possible to create API keys using the Elasticsearch
<a href="/guide/en/elasticsearch/reference/master/security-api-create-api-key.html" class="ulink" target="_top">create API key API</a>.</p>
<p>This example creates an API key named <code class="literal">java-002</code>:</p>
<div class="pre_wrapper lang-kibana">
<pre class="programlisting prettyprint lang-kibana">POST /_security/api_key
{
  "name": "java-002", <a id="CO44-1"></a><i class="conum" data-value="1"></i>
  "expiration": "1d", <a id="CO44-2"></a><i class="conum" data-value="2"></i>
  "role_descriptors": {
    "apm": {
      "applications": [
        {
          "application": "apm",
          "privileges": ["sourcemap:write", "event:write", "config_agent:read"], <a id="CO44-3"></a><i class="conum" data-value="3"></i>
          "resources": ["*"]
        }
      ]
    }
  }
}</pre>
</div>
<div class="kibana_widget" data-snippet="snippets/16.kibana"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO44-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The name of the API key</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO44-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The expiration time of the API key</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO44-3"><i class="conum" data-value="3"></i></a></p>
</td>
<td align="left" valign="top">
<p>Any assigned privileges</p>
</td>
</tr>
</table>
</div>
<p>The response will look similar to this:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
  "id" : "GnrUT3QB7yZbSNxKET6d",
  "name" : "java-002",
  "expiration" : 1599153532262,
  "api_key" : "RhHKisTmQ1aPCHC_TPwOvw"
}</pre>
</div>
<p>The <code class="literal">credential</code> string, which is what agents use to communicate with APM Server,
is a base64 encoded representation of the API key&#8217;s <code class="literal">id:api_key</code>.
It can be created like this:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">echo -n GnrUT3QB7yZbSNxKET6d:RhHKisTmQ1aPCHC_TPwOvw | base64</pre>
</div>
<p>You can verify your API key has been base64-encoded correctly with the
<a href="/guide/en/elasticsearch/reference/master/security-api-authenticate.html" class="ulink" target="_top">Authenticate API</a>:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">curl -H "Authorization: ApiKey R0gzRWIzUUI3eVpiU054S3pYSy06bXQyQWl4TlZUeEcyUjd4cUZDS0NlUQ==" localhost:9200/_security/_authenticate</pre>
</div>
<p>If the API key has been encoded correctly, you&#8217;ll see a response similar to the following:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">{
   "username":"1325298603",
   "roles":[],
   "full_name":null,
   "email":null,
   "metadata":{
      "saml_nameid_format":"urn:oasis:names:tc:SAML:2.0:nameid-format:transient",
      "saml(http://saml.elastic-cloud.com/attributes/principal)":[
         "1325298603"
      ],
      "saml_roles":[
         "superuser"
      ],
      "saml_principal":[
         "1325298603"
      ],
      "saml_nameid":"_7b0ab93bbdbc21d825edf7dca9879bd8d44c0be2",
      "saml(http://saml.elastic-cloud.com/attributes/roles)":[
         "superuser"
      ]
   },
   "enabled":true,
   "authentication_realm":{
      "name":"_es_api_key",
      "type":"_es_api_key"
   },
   "lookup_realm":{
      "name":"_es_api_key",
      "type":"_es_api_key"
   }
}</pre>
</div>
<p>You can then use the APM Server CLI to verify that the API key has the requested privileges:</p>
<div class="pre_wrapper lang-sh">
<pre class="programlisting prettyprint lang-sh">apm-server apikey verify --credentials R25yVVQzUUI3eVpiU054S0VUNmQ6UmhIS2lzVG1RMWFQQ0hDX1RQd092dw==</pre>
</div>
<p>If the API key has the requested privileges, the response will look similar to this:</p>
<div class="pre_wrapper lang-console-result">
<pre class="programlisting prettyprint lang-console-result">Authorized for privilege "config_agent:read"...:  Yes
Authorized for privilege "event:write"...:        Yes
Authorized for privilege "sourcemap:write"...:    Yes</pre>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="secret-token"></a>Secret token<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/apm-server/secret-token.asciidoc">edit</a></h4>
</div></div></div>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Secret tokens are sent as plain-text,
so they only provide security when used in combination with <a class="xref" href="secure-agent-communication.html#agent-tls" title="APM agent TLS communication">TLS</a>.</p>
</div>
</div>
<p>When defined, secret tokens are used to authorize requests to the APM Server.
Both the APM agent and APM Server must be configured with the same secret token for the request to be accepted.</p>
<p>To secure the communication between APM agents and the APM Server with a secret token:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Make sure <a class="xref" href="secure-agent-communication.html#agent-tls" title="APM agent TLS communication">TLS</a> is enabled
</li>
<li class="listitem">
<a class="xref" href="secure-agent-communication.html#create-secret-token" title="Create a secret token">Create a secret token</a>
</li>
<li class="listitem">
<a class="xref" href="secure-agent-communication.html#configure-secret-token" title="Configure the secret token in your APM agents">Configure the secret token in your APM agents</a>
</li>
</ol>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Secret tokens are not applicable for the RUM Agent,
as there is no way to prevent them from being publicly exposed.</p>
</div>
</div>
<h5><a id="create-secret-token"></a>Create a secret token<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/apm-server/secret-token.asciidoc">edit</a></h5>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Elasticsearch Service and Elastic Cloud Enterprise deployments provision a secret token when the deployment is created.
The secret token can be found and reset in the Elastic Cloud console under <span class="strong strong"><strong>Deployments</strong></span>&#8201;&#8212;&#8201;<span class="strong strong"><strong>APM &amp; Fleet</strong></span>.</p>
</div>
</div>
<div class="tabs" data-tab-group="ts">
  <div role="tablist" aria-label="tls">
    <button role="tab"
            aria-selected="true"
            aria-controls="fm-tab-ts"
            id="fm-ts">
      Fleet-managed
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="binary-tab-ts"
            id="binary-ts"
            tabindex="-1">
      APM Server binary
    </button>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="fm-tab-ts"
       aria-labelledby="fm-ts">
<p>Create or update a secret token in Fleet.</p>
<p>Configure and customize Fleet-managed APM settings directly in Kibana:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Open Kibana and navigate to <span class="strong strong"><strong>Fleet</strong></span>.
</li>
<li class="listitem">
Under the <span class="strong strong"><strong>Agent policies</strong></span> tab, select the policy you would like to configure.
</li>
<li class="listitem">
Find the Elastic APM integration and select <span class="strong strong"><strong>Actions</strong></span> &gt; <span class="strong strong"><strong>Edit integration</strong></span>.
</li>
<li class="listitem">
Navigate to <span class="strong strong"><strong>Agent authorization</strong></span> &gt; <span class="strong strong"><strong>Secret token</strong></span> and set the value of your token.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Save integration</strong></span>. The APM Server will restart before the change takes effect.
</li>
</ol>
</div>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="binary-tab-ts"
       aria-labelledby="binary-ts"
       hidden="">
<p>Set the secret token in <code class="literal">apm-server.yaml</code>:</p>
<div class="pre_wrapper lang-yaml">
<pre class="programlisting prettyprint lang-yaml">apm-server.auth.secret_token: &lt;secret-token&gt;</pre>
</div>
  </div>
</div>
<h5><a id="configure-secret-token"></a>Configure the secret token in your APM agents<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/apm-server/secret-token.asciidoc">edit</a></h5>
<p>Each Elastic APM agent has a configuration option to set the value of the secret token:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Go agent</strong></span>: <a href="/guide/en/apm/agent/go/current/configuration.html#config-secret-token" class="ulink" target="_top"><code class="literal">ELASTIC_APM_SECRET_TOKEN</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>iOS agent</strong></span>: <a href="/guide/en/apm/agent/swift/0.x/configuration.html#secretToken" class="ulink" target="_top"><code class="literal">secretToken</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>Java agent</strong></span>: <a href="/guide/en/apm/agent/java/current/config-reporter.html#config-secret-token" class="ulink" target="_top"><code class="literal">secret_token</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>.NET agent</strong></span>: <a href="/guide/en/apm/agent/dotnet/current/config-reporter.html#config-secret-token" class="ulink" target="_top"><code class="literal">ELASTIC_APM_SECRET_TOKEN</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>Node.js agent</strong></span>: <a href="/guide/en/apm/agent/nodejs/current/configuration.html#secret-token" class="ulink" target="_top"><code class="literal">Secret Token</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>PHP agent</strong></span>: <a href="/guide/en/apm/agent/php/1.x/configuration-reference.html#config-secret-token" class="ulink" target="_top"><code class="literal">secret_token</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>Python agent</strong></span>: <a href="/guide/en/apm/agent/python/current/configuration.html#config-secret-token" class="ulink" target="_top"><code class="literal">secret_token</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>Ruby agent</strong></span>: <a href="/guide/en/apm/agent/ruby/current/configuration.html#config-secret-token" class="ulink" target="_top"><code class="literal">secret_token</code></a>
</li>
</ul>
</div>
<p>In addition to setting the secret token, ensure the configured server URL uses <code class="literal">HTTPS</code> instead of <code class="literal">HTTP</code>:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<span class="strong strong"><strong>Go agent</strong></span>: <a href="/guide/en/apm/agent/go/current/configuration.html#config-server-url" class="ulink" target="_top"><code class="literal">ELASTIC_APM_SERVER_URL</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>Java agent</strong></span>: <a href="/guide/en/apm/agent/java/current/config-reporter.html#config-server-urls" class="ulink" target="_top"><code class="literal">server_urls</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>.NET agent</strong></span>: <a href="/guide/en/apm/agent/dotnet/current/config-reporter.html#config-server-url" class="ulink" target="_top"><code class="literal">ServerUrl</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>Node.js agent</strong></span>: <a href="/guide/en/apm/agent/nodejs/current/configuration.html#server-url" class="ulink" target="_top"><code class="literal">serverUrl</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>PHP agent</strong></span>: <a href="/guide/en/apm/agent/php/1.x/configuration-reference.html#config-server-url" class="ulink" target="_top"><code class="literal">server_url</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>Python agent</strong></span>: <a href="/guide/en/apm/agent/python/current/" class="ulink" target="_top"><code class="literal">server_url</code></a>
</li>
<li class="listitem">
<span class="strong strong"><strong>Ruby agent</strong></span>: <a href="/guide/en/apm/agent/ruby/current/configuration.html#config-server-url" class="ulink" target="_top"><code class="literal">server_url</code></a>
</li>
</ul>
</div>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h4 class="title"><a id="anonymous-auth"></a>Anonymous authentication<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/apm-server/anonymous-auth.asciidoc">edit</a></h4>
</div></div></div>
<p>Elastic APM agents can send unauthenticated (anonymous) events to the APM Server.
An event is considered to be anonymous if no authentication token can be extracted from the incoming request.
The APM Server&#8217;s default response to these these requests depends on its configuration:</p>
<div class="informaltable">
<table border="1" cellpadding="4px">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">Configuration</th>
<th align="left" valign="top">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p>An <a class="xref" href="secure-agent-communication.html#api-key" title="API keys">API key</a> or <a class="xref" href="secure-agent-communication.html#secret-token" title="Secret token">secret token</a> is configured</p></td>
<td align="left" valign="top"><p>Anonymous requests are rejected and an authentication error is returned.</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>No API key or secret token is configured</p></td>
<td align="left" valign="top"><p>Anonymous requests are accepted by the APM Server.</p></td>
</tr>
</tbody>
</table>
</div>
<p>In some cases, however, it makes sense to allow both authenticated and anonymous requests.
For example, it isn&#8217;t possible to authenticate requests from front-end services as
the secret token or API key can&#8217;t be protected. This is the case with the Real User Monitoring (RUM)
agent running in a browser, or the iOS/Swift agent running in a user application.
However, you still likely want to authenticate requests from back-end services.
To solve this problem, you can enable anonymous authentication in the APM Server to allow the
ingestion of unauthenticated client-side APM data while still requiring authentication for server-side services.</p>
<h5><a id="anonymous-auth-config"></a>Configuring anonymous auth for client-side services<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/apm-server/anonymous-auth.asciidoc">edit</a></h5>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>You can only enable and configure anonymous authentication if an <a class="xref" href="secure-agent-communication.html#api-key" title="API keys">API key</a> or
<a class="xref" href="secure-agent-communication.html#secret-token" title="Secret token">secret token</a> is configured. If neither are configured, these settings will be ignored.</p>
</div>
</div>
<div class="tabs" data-tab-group="ts">
  <div role="tablist" aria-label="tls">
    <button role="tab"
            aria-selected="true"
            aria-controls="fm-tab-ts"
            id="fm-ts">
      Fleet-managed
    </button>
    <button role="tab"
            aria-selected="false"
            aria-controls="binary-tab-ts"
            id="binary-ts"
            tabindex="-1">
      APM Server binary
    </button>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="fm-tab-ts"
       aria-labelledby="fm-ts">
<p>When an <a class="xref" href="secure-agent-communication.html#api-key" title="API keys">API key</a> or <a class="xref" href="secure-agent-communication.html#secret-token" title="Secret token">secret token</a> is configured,
anonymous authentication must be enabled to collect RUM data.
Set <span class="strong strong"><strong>Anonymous Agent access</strong></span> to true to enable anonymous authentication.</p>
<p>When configuring anonymous authentication for client-side services,
there are a few configuration variables that can mitigate the impact of malicious requests to an
unauthenticated APM Server endpoint.</p>
<p>Use the <span class="strong strong"><strong>Allowed anonymous agents</strong></span> and <span class="strong strong"><strong>Allowed anonymous services</strong></span> configs to ensure that the
<code class="literal">agent.name</code> and <code class="literal">service.name</code> of each incoming request match a specified list.</p>
<p>Additionally, the APM Server can rate-limit unauthenticated requests based on the client IP address
(<code class="literal">client.ip</code>) of the request.
This allows you to specify the maximum number of requests allowed per unique IP address, per second.</p>
  </div>
  <div tabindex="0"
       role="tabpanel"
       id="binary-tab-ts"
       aria-labelledby="binary-ts"
       hidden="">
<p>When an <a class="xref" href="secure-agent-communication.html#api-key" title="API keys">API key</a> or <a class="xref" href="secure-agent-communication.html#secret-token" title="Secret token">secret token</a> is configured,
anonymous authentication must be enabled to collect RUM data.
To enable anonymous access, set either <a class="xref" href="configuration-rum.html#rum-enable" title="Enable RUM"><code class="literal">apm-server.rum.enabled</code></a> or
<a class="xref" href="configuration-anonymous.html#config-auth-anon-enabled" title="Anonymous Agent access"><code class="literal">apm-server.auth.anonymous.enabled</code></a> to <code class="literal">true</code>.</p>
<p>Because anyone can send anonymous events to the APM Server,
additional configuration variables are available to rate limit the number anonymous events the APM Server processes;
throughput is equal to the <code class="literal">rate_limit.ip_limit</code> times the <code class="literal">rate_limit.event_limit</code>.</p>
<p>See <a class="xref" href="configuration-anonymous.html" title="Configure anonymous authentication">Anonymous authentication</a> for a complete list of options and a sample configuration file.</p>
  </div>
</div>
<h5><a id="derive-client-ip"></a>Deriving an incoming request&#8217;s <code class="literal">client.ip</code> address<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/apm-server/anonymous-auth.asciidoc">edit</a></h5>
<p>The remote IP address of an incoming request might be different
from the end-user&#8217;s actual IP address, for example, because of a proxy. For this reason,
the APM Server attempts to derive the IP address of an incoming request from HTTP headers.
The supported headers are parsed in the following order:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<code class="literal">Forwarded</code>
</li>
<li class="listitem">
<code class="literal">X-Real-Ip</code>
</li>
<li class="listitem">
<code class="literal">X-Forwarded-For</code>
</li>
</ol>
</div>
<p>If none of these headers are present, the remote address for the incoming request is used.</p>
<h6><a id="derive-client-ip-concerns"></a>Using a reverse proxy or load balancer<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/observability-docs/edit/main/docs/en/apm-server/anonymous-auth.asciidoc">edit</a></h6>
<p>HTTP headers are easily modified;
it&#8217;s possible for anyone to spoof the derived <code class="literal">client.ip</code> value by changing or setting,
for example, the value of the <code class="literal">X-Forwarded-For</code> header.
For this reason, if any of your clients are not trusted,
we recommend setting up a reverse proxy or load balancer in front of the APM Server.</p>
<p>Using a proxy allows you to clear any existing IP-forwarding HTTP headers,
and replace them with one set by the proxy.
This prevents malicious users from cycling spoofed IP addresses to bypass the
APM Server&#8217;s rate limiting feature.</p>
</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="securing-apm-server.html">« Secure communication with the Elastic Stack</a>
</span>
<span class="next">
<a href="secure-comms-stack.html">Secure communication with the Elastic Stack »</a>
</span>
</div>
</div>

                  <!-- end body -->
                </div>

                <div class="col-12 order-3 col-lg-2 order-lg-3 h-almost-full-lg sticky-top-lg" id="right_col">
                  <div id="sticky_content">
                    <!-- The OTP is appended here -->
                    <div class="row">
                      <div class="col-0 col-md-4 col-lg-0" id="bottom_left_col"></div>
                      <div class="col-12 col-md-8 col-lg-12">
                        <div id="rtpcontainer">
                          <div class="mktg-promo" id="most-popular">
                            <p class="aside-heading">Most Popular</p>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-elasticsearch?page=docs&placement=top-video">
                                <p class="mb-0">Get Started with Elasticsearch</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/getting-started-kibana?page=docs&placement=top-video">
                                <p class="mb-0">Intro to Kibana</p>
                              </a>
                            </div>
                            <div class="pb-2">
                              <p class="media-type">Video</p>
                              <a href="https://www.elastic.co/webinars/introduction-elk-stack?page=docs&placement=top-video">
                                <p class="mb-0">ELK for Logs & Metrics</p>
                              </a>
                            </div>
                          </div>
                        </div>

                        <!-- Feedback widget -->
                        <div id="feedbackWidgetContainer"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

        </div>


        <div id='elastic-footer'></div>
        <script src='https://www.elastic.co/elastic-footer.js'></script>
        <!-- Footer Section end-->

      </section>
    </div>

    <!-- Feedback modal -->
    <div id="feedbackModalContainer"></div>

    <script src="/guide/static/jquery.js"></script>
    <script type="text/javascript" src="/guide/static/docs.js"></script>
    <script type="text/javascript">
  window.initial_state = {}</script>
  </body>
</html>
