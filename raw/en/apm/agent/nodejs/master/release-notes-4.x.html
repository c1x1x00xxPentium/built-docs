<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Node.js Agent version 4.x | APM Node.js Agent Reference [master] | Elastic</title>
<meta class="elastic" name="content" content="Node.js Agent version 4.x | APM Node.js Agent Reference [master]">

<link rel="home" href="index.html" title="APM Node.js Agent Reference [master]"/>
<link rel="up" href="release-notes.html" title="Release notes"/>
<link rel="prev" href="release-notes.html" title="Release notes"/>
<link rel="next" href="release-notes-3.x.html" title="Node.js Agent version 3.x"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="APM"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/APM Node.js Agent/Reference/master"/>
<meta name="DC.subject" content="APM"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body><div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link">
  <div id="related-products" class="dropdown">
  <div class="related-products-title">APM:</div>
  <div class="dropdown-anchor" tabindex="0">Node.js Agent Reference<span class="dropdown-icon"></span></div>
  <div class="dropdown-content">
  <ul>
  <li class="dropdown-category">APM</li>
  <ul>
  <li><a href="/guide/en/apm/guide/current/apm-overview.html">User Guide</a></li>
  </ul>
  <li class="dropdown-category">APM agents</li>
  <ul>
  <li><a href="/guide/en/apm/agent/android/current/intro.html">Android Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/go/current/introduction.html">Go Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/swift/current/intro.html">iOS Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/java/current/intro.html">Java Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/dotnet/current/intro.html">.NET Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/nodejs/current/intro.html">Node.js Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/php/current/intro.html">PHP Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/python/current/getting-started.html">Python Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/ruby/current/introduction.html">Ruby Agent Reference</a></li>
  <li><a href="/guide/en/apm/agent/rum-js/current/intro.html">Real User Monitoring JavaScript Agent Reference</a></li>
  </ul>
  <li class="dropdown-category">APM extensions</li>
  <ul>
  <li><a href="/guide/en/apm/lambda/current/aws-lambda-arch.html">Monitoring AWS Lambda Functions</a></li>
  <li><a href="/guide/en/apm/attacher/current/apm-attacher.html">Attacher</a></li>
  </ul>
  </ul>
  </div>
  </div>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="release-notes.html">Release notes</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="release-notes.html">« Release notes</a>
</span>
<span class="next">
<a href="release-notes-3.x.html">Node.js Agent version 3.x »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="release-notes-4.x"></a>Node.js Agent version 4.x<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h2>
</div></div></div>
<p>See the <a class="xref" href="upgrade-to-v4.html" title="Upgrade to v4.x">Upgrade to v4.x</a> guide.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="release-notes-4.0.0"></a>4.0.0 - 2023/09/07<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h3>
</div></div></div>
<h5><a id="_breaking_changes"></a>Breaking changes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Set the new minimum supported Node.js to version 14.17.0.
Users of earlier Node.js versions can use elastic-apm-node v3.x, which
supports back to Node.js v8.6.
</li>
<li class="listitem">
Ignore a <code class="literal">timer</code> option passed to <code class="literal">startTransaction()</code> and <code class="literal">startSpan()</code> APIs.
This option was never documented. It would be surprising if any user is
impacted by this.
</li>
<li class="listitem">
Remove long deprecated support for the <code class="literal">ELASTIC_APM_</code>-prefixed environment
variables for the <a class="xref" href="configuration.html#kubernetes-node-name" title="kubernetesNodeName">Kubernetes config options</a>. For
example, one must use <code class="literal">KUBERNETES_POD_NAME</code> and not
<code class="literal">ELASTIC_APM_KUBERNETES_POD_NAME</code>. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2661" class="ulink" target="_top">#2661</a>)
</li>
<li class="listitem">
The config option <code class="literal">filterHttpHeaders</code> is now <em>removed</em>. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/3539" class="ulink" target="_top">#3539</a>)
</li>
<li class="listitem">
Remove the deprecated <code class="literal">span.toString()</code> and <code class="literal">transaction.toString()</code> APIs.
See <a class="xref" href="upgrade-to-v4.html#v4-api-to-string" title="span.toString(), transaction.toString()">the upgrading doc</a> for details. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2348" class="ulink" target="_top">#2348</a>)
</li>
<li class="listitem">
Remove instrumentation support for the old <em>hapi</em> package&#8201;&#8212;&#8201;the current
<em>@hapi/hapi</em> package is still instrumented. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2691" class="ulink" target="_top">#2691</a>)
</li>
<li class="listitem">
Change <code class="literal">apm.startTransaction()</code> api to return a noop transaction instead of
null, if the agent is not yet started. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2429" class="ulink" target="_top">#2429</a>)
</li>
<li class="listitem">
Drop support for the obsolete "patch" context manager, i.e. the
<code class="literal">contextManager: "patch"</code> config option. This was a limited async context
management that predated the preferred <code class="literal">AsyncLocalStorage</code> core Node.js
mechanism for context tracking. It was deprecated in v3.37.0.  As well, the
related and deprecated <code class="literal">asyncHooks</code> config option has been removed.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/3529" class="ulink" target="_top">#3529</a>)
</li>
<li class="listitem">
Remove the <code class="literal">logUncaughtExceptions</code> config option.
See <a class="xref" href="upgrade-to-v4.html#v4-config-options" title="Config options">Upgrading to v4</a> for details.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/2412" class="ulink" target="_top">#2412</a>)
</li>
<li class="listitem">
Remove <code class="literal">transaction.subtype</code> and <code class="literal">transaction.action</code> properties from API.
This also impacts <a class="xref" href="agent-api.html#apm-start-transaction" title="apm.startTransaction([name][, type][, options])"><code class="literal">apm.startTransaction([name][, type][, options])</code></a> and <code class="literal">transaction.setType(...)</code>,
both of which now no longer accept <code class="literal">subtype</code> and <code class="literal">action</code> parameters.
These two properties were deprecated in v3.25.0.
(<a href="https://github.com/elastic/apm-agent-nodejs/issues/3557" class="ulink" target="_top">#3557</a>)
</li>
<li class="listitem">
Remove support for the erroneous <code class="literal">ELASTIC_SANITIZE_FIELD_NAMES</code> and
<code class="literal">ELASTIC_IGNORE_MESSAGE_QUEUES</code> config environment variables. The correct env
vars are <code class="literal">ELASTIC_APM_SANITIZE_FIELD_NAMES</code> and
<code class="literal">ELASTIC_APM_IGNORE_MESSAGE_QUEUES</code>, respectively, and were supported starting
in v3.36.0.
</li>
</ul>
</div>
<h5><a id="_features"></a>Features<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
The <code class="literal">apm.destroy()</code> method is now async. Almost no users should need to use
this method. However, if used, to be sure to wait for APM agent shutdown to
be complete, one can now <code class="literal">await apm.destroy()</code>. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/3222" class="ulink" target="_top">#3222</a>)
</li>
<li class="listitem">
Support instrumenting <code class="literal">mongodb</code> v6. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/3596" class="ulink" target="_top">#3596</a>)
</li>
</ul>
</div>
<h5><a id="_bug_fixes"></a>Bug fixes<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Fix instrumentation of <code class="literal">mongodb</code> to avoid multiple command handler
registrations when client is created via <code class="literal">MongoClient.connect</code> static
method. (<a href="https://github.com/elastic/apm-agent-nodejs/pull/3586" class="ulink" target="_top">#3586</a>)
</li>
</ul>
</div>
<h5><a id="_chores"></a>Chores<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/apm-agent-nodejs/edit/main/CHANGELOG.asciidoc">edit</a></h5>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Add a warning message when a duration or size config option is provided
without units. (<a href="https://github.com/elastic/apm-agent-nodejs/issues/2121" class="ulink" target="_top">#2121</a>)
</li>
<li class="listitem">
Change default value of <code class="literal">useElasticTraceparentHeader</code> config option to <code class="literal">false</code>.
This means that for outgoing HTTP requests, the APM agent will no longer add the
<code class="literal">elastic-apm-traceparent</code> header. This vendor-specific header was used in the past
while the <a href="https://w3c.github.io/trace-context/" class="ulink" target="_top">W3C trace-context</a> spec was still
in development. Now that it is in wide use, the <code class="literal">elastic-apm-traceparent</code> header is
only useful for interaction with very old Elastic APM agents.
</li>
<li class="listitem">
Add default ports into <code class="literal">context.service.target.name</code> for HTTP spans conforming to the
spec update done in <a href="https://github.com/elastic/apm/pull/700" class="ulink" target="_top">https://github.com/elastic/apm/pull/700</a> (<a href="https://github.com/elastic/apm-agent-nodejs/pull/3590" class="ulink" target="_top">#3590</a>)
</li>
</ul>
</div>
</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="release-notes.html">« Release notes</a>
</span>
<span class="next">
<a href="release-notes-3.x.html">Node.js Agent version 3.x »</a>
</span>
</div>
</div>
</body>
</html>
