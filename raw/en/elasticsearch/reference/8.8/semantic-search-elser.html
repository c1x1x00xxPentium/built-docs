<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Tutorial: semantic search with ELSER | Elasticsearch Guide [8.8] | Elastic</title>
<meta class="elastic" name="content" content="Tutorial: semantic search with ELSER | Elasticsearch Guide [8.8]">

<link rel="home" href="index.html" title="Elasticsearch Guide [8.8]"/>
<link rel="up" href="search-your-data.html" title="Search your data"/>
<link rel="prev" href="knn-search.html" title="k-nearest neighbor (kNN) search"/>
<link rel="next" href="query-dsl.html" title="Query DSL"/>
<meta class="elastic" name="product_version" content="8.8"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/8.8"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="8.8"/>
</head>
<body><div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [8.8]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="search-your-data.html">Search your data</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="knn-search.html">« k-nearest neighbor (kNN) search</a>
</span>
<span class="next">
<a href="query-dsl.html">Query DSL »</a>
</span>
</div>
<div class="chapter">
<div class="titlepage"><div><div>
<h2 class="title"><a id="semantic-search-elser"></a>Tutorial: semantic search with ELSER<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.8/docs/reference/search/search-your-data/semantic-search-elser.asciidoc">edit</a></h2>
</div></div></div>

<p>Elastic Learned Sparse EncodeR - or ELSER - is an NLP model trained by Elastic
that enables you to perform semantic search by using sparse vector
representation. Instead of literal matching on search terms, semantic search
retrieves results based on the intent and the contextual meaning of a search
query.</p>
<p>The instructions in this tutorial shows you how to use ELSER to perform semantic
search on your data.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Only the first 512 extracted tokens per field are considered during
semantic search with ELSER v1. Refer to
<a href="/guide/en/machine-learning/8.8/ml-nlp-limitations.html#ml-nlp-elser-v1-limit-512" class="ulink" target="_top">this page</a> for more
information.</p>
</div>
</div>
<h3><a id="requirements"></a>Requirements<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.8/docs/reference/search/search-your-data/semantic-search-elser.asciidoc">edit</a></h3>
<p>To perform semantic search by using ELSER, you must have the NLP model deployed
in your cluster. Refer to the
<a href="/guide/en/machine-learning/8.8/ml-nlp-elser.html" class="ulink" target="_top">ELSER documentation</a> to learn how to download and
deploy the model.</p>
<h3><a id="elser-mappings"></a>Create the index mapping<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.8/docs/reference/search/search-your-data/semantic-search-elser.asciidoc">edit</a></h3>
<p>First, the mapping of the destination index - the index that contains the tokens
that the model created based on your text - must be created.  The destination
index must have a field with the <a class="xref" href="rank-features.html" title="Rank features field type"><code class="literal">rank_features</code></a> field type
to index the ELSER output.</p>
<a id="ff8317bbd60e9dfc6bf007028a18b531"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT my-index
{
  "mappings": {
    "properties": {
      "ml.tokens": {
        "type": "rank_features" <a id="CO202-1"></a><i class="conum" data-value="1"></i>
      },
      "text_field": {
        "type": "text" <a id="CO202-2"></a><i class="conum" data-value="2"></i>
      }
    }
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/919.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO202-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The field that contains the prediction is a <code class="literal">rank_features</code> field.</p>
</td>
</tr>
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO202-2"><i class="conum" data-value="2"></i></a></p>
</td>
<td align="left" valign="top">
<p>The text field from which to create the sparse vector representation.</p>
</td>
</tr>
</table>
</div>
<h3><a id="inference-ingest-pipeline"></a>Create an ingest pipeline with an inference processor<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.8/docs/reference/search/search-your-data/semantic-search-elser.asciidoc">edit</a></h3>
<p>Create an <a class="xref" href="ingest.html" title="Ingest pipelines">ingest pipeline</a> with an
<a class="xref" href="inference-processor.html" title="Inference processor">inference processor</a> to use ELSER to infer against the data
that is being ingested in the pipeline.</p>
<a id="7cc603d7e8373a01eae7bb0d18824632"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">PUT _ingest/pipeline/elser-v1-test
{
  "processors": [
    {
      "inference": {
        "model_id": ".elser_model_1",
        "target_field": "ml",
        "field_map": {
          "text": "text_field"
        },
        "inference_config": {
          "text_expansion": { <a id="CO203-1"></a><i class="conum" data-value="1"></i>
            "results_field": "tokens"
          }
        }
      }
    }
  ]
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/920.console"></div>
<div class="calloutlist">
<table border="0" summary="Callout list">
<tr>
<td align="left" valign="top" width="5%">
<p><a href="#CO203-1"><i class="conum" data-value="1"></i></a></p>
</td>
<td align="left" valign="top">
<p>The <code class="literal">text_expansion</code> inference type needs to be used in the inference ingest
processor.</p>
</td>
</tr>
</table>
</div>
<h3><a id="load-data"></a>Load data<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.8/docs/reference/search/search-your-data/semantic-search-elser.asciidoc">edit</a></h3>
<p>In this step, you load the data that you later use in the inference ingest
pipeline to extract tokens from it.</p>
<p>Use the <code class="literal">msmarco-passagetest2019-top1000</code> data set, which is a subset of the MS
MACRO Passage Ranking data set. It consists of 200 queries, each accompanied by
a list of relevant text passages. All unique passages, along with their IDs,
have been extracted from that data set and compiled into a
<a href="https://github.com/elastic/stack-docs/blob/main/docs/en/stack/ml/nlp/data/msmarco-passagetest2019-unique.tsv" class="ulink" target="_top">tsv file</a>.</p>
<p>Download the file and upload it to your cluster using the
<a href="/guide/en/kibana/8.8/connect-to-elasticsearch.html#upload-data-kibana" class="ulink" target="_top">Data Visualizer</a>
in the Machine Learning UI. Assign the name <code class="literal">id</code> to the first column and <code class="literal">text</code> to the
second column. The index name is <code class="literal">test-data</code>. Once the upload is complete, you
can see an index named <code class="literal">test-data</code> with 182469 documents.</p>
<h3><a id="reindexing-data-elser"></a>Ingest the data through the inference ingest pipeline<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.8/docs/reference/search/search-your-data/semantic-search-elser.asciidoc">edit</a></h3>
<p>Create the tokens from the text by reindexing the data throught the inference
pipeline that uses ELSER as the inference model.</p>
<a id="dfb1ce43b4f96dcb3c8dcc8370aa9965"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">POST _reindex?wait_for_completion=false
{
  "source": {
    "index": "test-data"
  },
  "dest": {
    "index": "my-index",
    "pipeline": "elser-v1-test"
  }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/921.console"></div>
<p>The call returns a task ID to monitor the progress:</p>
<a id="8a1b6eae4893c5dd27b3d81fd8d70f5b"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET _tasks/&lt;task_id&gt;</pre>
</div>
<div class="console_widget" data-snippet="snippets/922.console"></div>
<p>You can also open the Trained Models UI, select the Pipelines tab under ELSER to
follow the progress. It may take a couple of minutes to complete the process.</p>
<h3><a id="text-expansion-query"></a>Semantic search by using the <code class="literal">text_expansion</code> query<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.8/docs/reference/search/search-your-data/semantic-search-elser.asciidoc">edit</a></h3>
<p>To perform semantic search, use the <code class="literal">text_expansion</code> query,
and provide the query text and the ELSER model ID. The example below uses
the query text "How to avoid muscle soreness after running?":</p>
<a id="a4709da258a667cae4199ec3a1e84b3b"></a>
<div class="pre_wrapper lang-console">
<pre class="programlisting prettyprint lang-console">GET my-index/_search
{
   "query":{
      "text_expansion":{
         "ml.tokens":{
            "model_id":".elser_model_1",
            "model_text":"How to avoid muscle soreness after running?"
         }
      }
   }
}</pre>
</div>
<div class="console_widget" data-snippet="snippets/923.console"></div>
<p>The result is the top 10 documents that are closest in meaning to your query
text from the <code class="literal">my-index</code> index sorted by their relevancy. The result also
contains the extracted tokens for each of the relevant search results with their
weights.</p>
<div class="pre_wrapper lang-consol-result">
<pre class="programlisting prettyprint lang-consol-result">"hits":[
   {
      "_index":"my-index",
      "_id":"978UAYgBKCQMet06sLEy",
      "_score":18.612831,
      "_ignored":[
         "text.keyword"
      ],
      "_source":{
         "id":7361587,
         "text":"For example, if you go for a run, you will mostly use the muscles in your lower body. Give yourself 2 days to rest those muscles so they have a chance to heal before you exercise them again. Not giving your muscles enough time to rest can cause muscle damage, rather than muscle development.",
         "ml":{
            "tokens":{
               "muscular":0.075696334,
               "mostly":0.52380747,
               "practice":0.23430172,
               "rehab":0.3673556,
               "cycling":0.13947526,
               "your":0.35725075,
               "years":0.69484913,
               "soon":0.005317828,
               "leg":0.41748235,
               "fatigue":0.3157955,
               "rehabilitation":0.13636169,
               "muscles":1.302141,
               "exercises":0.36694175,
               (...)
            },
            "model_id":".elser_model_1"
         }
      }
   },
   (...)
]</pre>
</div>
<h3><a id="further-reading"></a>Further reading<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/8.8/docs/reference/search/search-your-data/semantic-search-elser.asciidoc">edit</a></h3>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a href="/guide/en/machine-learning/8.8/ml-nlp-elser.html" class="ulink" target="_top">How to download and deploy ELSER</a>
</li>
<li class="listitem">
<a href="/guide/en/machine-learning/8.8/ml-nlp-limitations.html#ml-nlp-elser-v1-limit-512" class="ulink" target="_top">ELSER v1 limitation</a>
</li>
</ul>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="knn-search.html">« k-nearest neighbor (kNN) search</a>
</span>
<span class="next">
<a href="query-dsl.html">Query DSL »</a>
</span>
</div>
</div>
</body>
</html>
