<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ES|QL aggregate functions | Elasticsearch Guide [master] | Elastic</title>
<meta class="elastic" name="content" content="ES|QL aggregate functions | Elasticsearch Guide [master]">

<link rel="home" href="index.html" title="Elasticsearch Guide [master]"/>
<link rel="up" href="esql-functions-operators.html" title="ES|QL functions and operators"/>
<link rel="prev" href="esql-functions-operators.html" title="ES|QL functions and operators"/>
<link rel="next" href="esql-math-functions.html" title="ES|QL mathematical functions"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/master"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body><div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="esql.html">ES|QL</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="esql-functions-operators.html">ES|QL functions and operators</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="esql-functions-operators.html">« ES|QL functions and operators</a>
</span>
<span class="next">
<a href="esql-math-functions.html">ES|QL mathematical functions »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="esql-agg-functions"></a>ES|QL aggregate functions<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/esql/functions/aggregation-functions.asciidoc">edit</a></h2>
</div></div></div>

<p>The <a class="xref" href="esql-processing-commands.html#esql-stats-by" title="STATS ... BY"><code class="literal">STATS ... BY</code></a> function supports these aggregate functions:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<a class="xref" href="esql-agg-functions.html#esql-agg-avg" title="AVG"><code class="literal">AVG</code></a>
</li>
<li class="listitem">
<a class="xref" href="esql-agg-functions.html#esql-agg-count" title="COUNT"><code class="literal">COUNT</code></a>
</li>
<li class="listitem">
<a class="xref" href="esql-agg-functions.html#esql-agg-count-distinct" title="COUNT_DISTINCT"><code class="literal">COUNT_DISTINCT</code></a>
</li>
<li class="listitem">
<a class="xref" href="esql-agg-functions.html#esql-agg-max" title="MAX"><code class="literal">MAX</code></a>
</li>
<li class="listitem">
<a class="xref" href="esql-agg-functions.html#esql-agg-median" title="MEDIAN"><code class="literal">MEDIAN</code></a>
</li>
<li class="listitem">
<a class="xref" href="esql-agg-functions.html#esql-agg-median-absolute-deviation" title="MEDIAN_ABSOLUTE_DEVIATION"><code class="literal">MEDIAN_ABSOLUTE_DEVIATION</code></a>
</li>
<li class="listitem">
<a class="xref" href="esql-agg-functions.html#esql-agg-min" title="MIN"><code class="literal">MIN</code></a>
</li>
<li class="listitem">
<a class="xref" href="esql-agg-functions.html#esql-agg-percentile" title="PERCENTILE"><code class="literal">PERCENTILE</code></a>
</li>
<li class="listitem">
<a class="xref" href="esql-agg-functions.html#esql-agg-sum" title="SUM"><code class="literal">SUM</code></a>
</li>
</ul>
</div>
<h3><a id="esql-agg-avg"></a><code class="literal">AVG</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/esql/functions/avg.asciidoc">edit</a></h3>
<p>The average of a numeric field.</p>
<div class="pre_wrapper lang-esql merge styled">
<pre class="programlisting prettyprint lang-esql merge styled">FROM employees
| STATS AVG(height)</pre>
</div>
<div class="informaltable">
<table border="1" cellpadding="4px" class="monospaced styled">
<colgroup>
<col class="col_1"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">AVG(height):double</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p>1.7682</p></td>
</tr>
</tbody>
</table>
</div>
<p>The result is always a <code class="literal">double</code> not matter the input type.</p>
<h3><a id="esql-agg-count"></a><code class="literal">COUNT</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/esql/functions/count.asciidoc">edit</a></h3>
<p>Counts field values.</p>
<div class="pre_wrapper lang-esql merge styled">
<pre class="programlisting prettyprint lang-esql merge styled">FROM employees
| STATS COUNT(height)</pre>
</div>
<div class="informaltable">
<table border="1" cellpadding="4px" class="monospaced styled">
<colgroup>
<col class="col_1"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">COUNT(height):long</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p>100</p></td>
</tr>
</tbody>
</table>
</div>
<p>Can take any field type as input and the result is always a <code class="literal">long</code> not matter
the input type.</p>
<p>To count the number of rows, use <code class="literal">COUNT(*)</code>:</p>
<div class="pre_wrapper lang-esql merge styled">
<pre class="programlisting prettyprint lang-esql merge styled">FROM employees
| STATS count = COUNT(*) BY languages
| SORT languages DESC</pre>
</div>
<div class="informaltable">
<table border="1" cellpadding="4px" class="monospaced styled">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">count:long</th>
<th align="left" valign="top">languages:integer</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p>10</p></td>
<td align="left" valign="top"><p>null</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>21</p></td>
<td align="left" valign="top"><p>5</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>18</p></td>
<td align="left" valign="top"><p>4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>17</p></td>
<td align="left" valign="top"><p>3</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>19</p></td>
<td align="left" valign="top"><p>2</p></td>
</tr>
<tr>
<td align="left" valign="top"><p>15</p></td>
<td align="left" valign="top"><p>1</p></td>
</tr>
</tbody>
</table>
</div>
<h3><a id="esql-agg-count-distinct"></a><code class="literal">COUNT_DISTINCT</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/esql/functions/count-distinct.asciidoc">edit</a></h3>
<p>The approximate number of distinct values.</p>
<div class="pre_wrapper lang-esql merge styled">
<pre class="programlisting prettyprint lang-esql merge styled">FROM hosts
| STATS COUNT_DISTINCT(ip0), COUNT_DISTINCT(ip1)</pre>
</div>
<div class="informaltable">
<table border="1" cellpadding="4px" class="monospaced styled">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">COUNT_DISTINCT(ip0):long</th>
<th align="left" valign="top">COUNT_DISTINCT(ip1):long</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p>7</p></td>
<td align="left" valign="top"><p>8</p></td>
</tr>
</tbody>
</table>
</div>
<p>Can take any field type as input and the result is always a <code class="literal">long</code> not matter
the input type.</p>
<h4><a id="_counts_are_approximate_2"></a>Counts are approximate<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/esql/functions/count-distinct.asciidoc">edit</a></h4>
<p>Computing exact counts requires loading values into a set and returning its
size. This doesn&#8217;t scale when working on high-cardinality sets and/or large
values as the required memory usage and the need to communicate those
per-shard sets between nodes would utilize too many resources of the cluster.</p>
<p>This <code class="literal">COUNT_DISTINCT</code> function is based on the
<a href="https://static.googleusercontent.com/media/research.google.com/fr//pubs/archive/40671.pdf" class="ulink" target="_top">HyperLogLog++</a>
algorithm, which counts based on the hashes of the values with some interesting
properties:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
configurable precision, which decides on how to trade memory for accuracy,
</li>
<li class="listitem">
excellent accuracy on low-cardinality sets,
</li>
<li class="listitem">
fixed memory usage: no matter if there are tens or billions of unique values,
memory usage only depends on the configured precision.
</li>
</ul>
</div>
<p>For a precision threshold of <code class="literal">c</code>, the implementation that we are using requires
about <code class="literal">c * 8</code> bytes.</p>
<p>The following chart shows how the error varies before and after the threshold:</p>
<p><span class="image"><img src="images/cardinality_error.png" alt="cardinality error"></span></p>
<p>For all 3 thresholds, counts have been accurate up to the configured threshold.
Although not guaranteed, this is likely to be the case. Accuracy in practice depends
on the dataset in question. In general, most datasets show consistently good
accuracy. Also note that even with a threshold as low as 100, the error
remains very low (1-6% as seen in the above graph) even when counting millions of items.</p>
<p>The HyperLogLog++ algorithm depends on the leading zeros of hashed
values, the exact distributions of hashes in a dataset can affect the
accuracy of the cardinality.</p>
<h4><a id="_precision_is_configurable"></a>Precision is configurable<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/esql/functions/count-distinct.asciidoc">edit</a></h4>
<p>The <code class="literal">COUNT_DISTINCT</code> function takes an optional second parameter to configure the
precision discussed previously.</p>
<div class="pre_wrapper lang-esql merge styled">
<pre class="programlisting prettyprint lang-esql merge styled">FROM hosts
| STATS COUNT_DISTINCT(ip0, 80000), COUNT_DISTINCT(ip1, 5)</pre>
</div>
<div class="informaltable">
<table border="1" cellpadding="4px" class="monospaced styled">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">COUNT_DISTINCT(ip0,80000):long</th>
<th align="left" valign="top">COUNT_DISTINCT(ip1,5):long</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p>7</p></td>
<td align="left" valign="top"><p>9</p></td>
</tr>
</tbody>
</table>
</div>
<h3><a id="esql-agg-max"></a><code class="literal">MAX</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/esql/functions/max.asciidoc">edit</a></h3>
<p>The maximum value of a numeric field.</p>
<div class="pre_wrapper lang-esql merge styled">
<pre class="programlisting prettyprint lang-esql merge styled">FROM employees
| STATS MAX(languages)</pre>
</div>
<div class="informaltable">
<table border="1" cellpadding="4px" class="monospaced styled">
<colgroup>
<col class="col_1"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">MAX(languages):integer</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p>5</p></td>
</tr>
</tbody>
</table>
</div>
<h3><a id="esql-agg-median"></a><code class="literal">MEDIAN</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/esql/functions/median.asciidoc">edit</a></h3>
<p>The value that is greater than half of all values and less than half of
all values, also known as the 50% <a class="xref" href="esql-agg-functions.html#esql-agg-percentile" title="PERCENTILE"><code class="literal">PERCENTILE</code></a>.</p>
<div class="pre_wrapper lang-esql merge styled">
<pre class="programlisting prettyprint lang-esql merge styled">FROM employees
| STATS MEDIAN(salary), PERCENTILE(salary, 50)</pre>
</div>
<div class="informaltable">
<table border="1" cellpadding="4px" class="monospaced styled">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">MEDIAN(salary):double</th>
<th align="left" valign="top">PERCENTILE(salary,50):double</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p>47003</p></td>
<td align="left" valign="top"><p>47003</p></td>
</tr>
</tbody>
</table>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Like <a class="xref" href="esql-agg-functions.html#esql-agg-percentile" title="PERCENTILE"><code class="literal">PERCENTILE</code></a>, <code class="literal">MEDIAN</code> is <a class="xref" href="esql-agg-functions.html#esql-agg-percentile-approximate" title="PERCENTILE is (usually) approximate">usually approximate</a>.</p>
</div>
</div>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p><code class="literal">MEDIAN</code> is also <a href="https://en.wikipedia.org/wiki/Nondeterministic_algorithm" class="ulink" target="_top">non-deterministic</a>.
This means you can get slightly different results using the same data.</p>
</div>
</div>
<h3><a id="esql-agg-median-absolute-deviation"></a><code class="literal">MEDIAN_ABSOLUTE_DEVIATION</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/esql/functions/median-absolute-deviation.asciidoc">edit</a></h3>
<p>The median absolute deviation, a measure of variability. It is a robust
statistic, meaning that it is useful for describing data that may have outliers,
or may not be normally distributed. For such data it can be more descriptive than
standard deviation.</p>
<p>It is calculated as the median of each data point’s deviation from the median of
the entire sample. That is, for a random variable <code class="literal">X</code>, the median absolute deviation
is <code class="literal">median(|median(X) - Xi|)</code>.</p>
<div class="pre_wrapper lang-esql merge styled">
<pre class="programlisting prettyprint lang-esql merge styled">FROM employees
| STATS MEDIAN(salary), MEDIAN_ABSOLUTE_DEVIATION(salary)</pre>
</div>
<div class="informaltable">
<table border="1" cellpadding="4px" class="monospaced styled">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">MEDIAN(salary):double</th>
<th align="left" valign="top">MEDIAN_ABSOLUTE_DEVIATION(salary):double</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p>47003</p></td>
<td align="left" valign="top"><p>10096.5</p></td>
</tr>
</tbody>
</table>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>Like <a class="xref" href="esql-agg-functions.html#esql-agg-percentile" title="PERCENTILE"><code class="literal">PERCENTILE</code></a>, <code class="literal">MEDIAN_ABSOLUTE_DEVIATION</code> is
      <a class="xref" href="esql-agg-functions.html#esql-agg-percentile-approximate" title="PERCENTILE is (usually) approximate">usually approximate</a>.</p>
</div>
</div>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p><code class="literal">MEDIAN_ABSOLUTE_DEVIATION</code> is also <a href="https://en.wikipedia.org/wiki/Nondeterministic_algorithm" class="ulink" target="_top">non-deterministic</a>.
This means you can get slightly different results using the same data.</p>
</div>
</div>
<h3><a id="esql-agg-min"></a><code class="literal">MIN</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/esql/functions/min.asciidoc">edit</a></h3>
<p>The minimum value of a numeric field.</p>
<div class="pre_wrapper lang-esql merge styled">
<pre class="programlisting prettyprint lang-esql merge styled">FROM employees
| STATS MIN(languages)</pre>
</div>
<div class="informaltable">
<table border="1" cellpadding="4px" class="monospaced styled">
<colgroup>
<col class="col_1"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">MIN(languages):integer</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p>1</p></td>
</tr>
</tbody>
</table>
</div>
<h3><a id="esql-agg-percentile"></a><code class="literal">PERCENTILE</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/esql/functions/percentile.asciidoc">edit</a></h3>
<p>The value at which a certain percentage of observed values occur. For example,
the 95th percentile is the value which is greater than 95% of the observed values and
the 50th percentile is the <a class="xref" href="esql-agg-functions.html#esql-agg-median" title="MEDIAN"><code class="literal">MEDIAN</code></a>.</p>
<div class="pre_wrapper lang-esql merge styled">
<pre class="programlisting prettyprint lang-esql merge styled">FROM employees
| STATS p0 = PERCENTILE(salary,  0)
     , p50 = PERCENTILE(salary, 50)
     , p99 = PERCENTILE(salary, 99)</pre>
</div>
<div class="informaltable">
<table border="1" cellpadding="4px" class="monospaced styled">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
<col class="col_3"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">p0:double</th>
<th align="left" valign="top">p50:double</th>
<th align="left" valign="top">p99:double</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p>25324</p></td>
<td align="left" valign="top"><p>47003</p></td>
<td align="left" valign="top"><p>74970.29</p></td>
</tr>
</tbody>
</table>
</div>
<h4><a id="esql-agg-percentile-approximate"></a><code class="literal">PERCENTILE</code> is (usually) approximate<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/esql/functions/percentile.asciidoc">edit</a></h4>
<p>There are many different algorithms to calculate percentiles. The naive
implementation simply stores all the values in a sorted array. To find the 50th
percentile, you simply find the value that is at <code class="literal">my_array[count(my_array) * 0.5]</code>.</p>
<p>Clearly, the naive implementation does not scale&#8201;&#8212;&#8201;the sorted array grows
linearly with the number of values in your dataset. To calculate percentiles
across potentially billions of values in an Elasticsearch cluster, <em>approximate</em>
percentiles are calculated.</p>
<p>The algorithm used by the <code class="literal">percentile</code> metric is called TDigest (introduced by
Ted Dunning in
<a href="https://github.com/tdunning/t-digest/blob/master/docs/t-digest-paper/histo.pdf" class="ulink" target="_top">Computing Accurate Quantiles using T-Digests</a>).</p>
<p>When using this metric, there are a few guidelines to keep in mind:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
Accuracy is proportional to <code class="literal">q(1-q)</code>. This means that extreme percentiles (e.g. 99%)
are more accurate than less extreme percentiles, such as the median
</li>
<li class="listitem">
For small sets of values, percentiles are highly accurate (and potentially
100% accurate if the data is small enough).
</li>
<li class="listitem">
As the quantity of values in a bucket grows, the algorithm begins to approximate
the percentiles. It is effectively trading accuracy for memory savings. The
exact level of inaccuracy is difficult to generalize, since it depends on your
data distribution and volume of data being aggregated
</li>
</ul>
</div>
<p>The following chart shows the relative error on a uniform distribution depending
on the number of collected values and the requested percentile:</p>
<p><span class="image"><img src="images/percentiles_error.png" alt="percentiles error"></span></p>
<p>It shows how precision is better for extreme percentiles. The reason why error diminishes
for large number of values is that the law of large numbers makes the distribution of
values more and more uniform and the t-digest tree can do a better job at summarizing
it. It would not be the case on more skewed distributions.</p>
<div class="warning admon">
<div class="icon"></div>
<div class="admon_content">
<p><code class="literal">PERCENTILE</code> is also <a href="https://en.wikipedia.org/wiki/Nondeterministic_algorithm" class="ulink" target="_top">non-deterministic</a>.
This means you can get slightly different results using the same data.</p>
</div>
</div>
<h3><a id="esql-agg-sum"></a><code class="literal">SUM</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/esql/functions/sum.asciidoc">edit</a></h3>
<p>The sum of a numeric field.</p>
<div class="pre_wrapper lang-esql merge styled">
<pre class="programlisting prettyprint lang-esql merge styled">FROM employees
| STATS SUM(languages)</pre>
</div>
<div class="informaltable">
<table border="1" cellpadding="4px" class="monospaced styled">
<colgroup>
<col class="col_1"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">SUM(languages):long</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p>281</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="esql-functions-operators.html">« ES|QL functions and operators</a>
</span>
<span class="next">
<a href="esql-math-functions.html">ES|QL mathematical functions »</a>
</span>
</div>
</div>
</body>
</html>
