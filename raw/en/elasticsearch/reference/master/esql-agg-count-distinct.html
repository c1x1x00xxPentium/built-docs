<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>COUNT_DISTINCT | Elasticsearch Guide [master] | Elastic</title>
<meta class="elastic" name="content" content="COUNT_DISTINCT | Elasticsearch Guide [master]">

<link rel="home" href="index.html" title="Elasticsearch Guide [master]"/>
<link rel="up" href="esql-agg-functions.html" title="ES|QL aggregation functions"/>
<link rel="prev" href="esql-agg-count.html" title="COUNT"/>
<link rel="next" href="esql-agg-max.html" title="MAX"/>
<meta class="elastic" name="product_version" content="master"/>
<meta class="elastic" name="product_name" content="Elasticsearch"/>
<meta class="elastic" name="website_area" content="documentation"/>
<meta name="DC.type" content="Learn/Docs/Elasticsearch/Reference/master"/>
<meta name="DC.subject" content="Elasticsearch"/>
<meta name="DC.identifier" content="master"/>
<meta name="robots" content="noindex,nofollow"/>
</head>
<body><div class="page_header">
You are looking at preliminary documentation for a future release.
Not what you want? See the
<a href="../current/index.html">current release documentation</a>.
</div>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="/guide/">Elastic Docs</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="index.html">Elasticsearch Guide [master]</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="esql.html">ES|QL</a></span>
<span class="chevron-right">›</span><span class="breadcrumb-link"><a href="esql-agg-functions.html">ES|QL aggregation functions</a></span>
</div>
<div class="navheader">
<span class="prev">
<a href="esql-agg-count.html">« <code class="literal">COUNT</code></a>
</span>
<span class="next">
<a href="esql-agg-max.html"><code class="literal">MAX</code> »</a>
</span>
</div>
<div class="section">
<div class="titlepage"><div><div>
<h2 class="title"><a id="esql-agg-count-distinct"></a><code class="literal">COUNT_DISTINCT</code><a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/esql/aggregation-functions/count-distinct.asciidoc">edit</a></h2>
</div></div></div>
<p>The approximate number of distinct values.</p>
<div class="pre_wrapper lang-esql merge styled">
<pre class="programlisting prettyprint lang-esql merge styled">FROM hosts
| STATS COUNT_DISTINCT(ip0), COUNT_DISTINCT(ip1)</pre>
</div>
<div class="informaltable">
<table border="1" cellpadding="4px" class="monospaced styled">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">COUNT_DISTINCT(ip0):long</th>
<th align="left" valign="top">COUNT_DISTINCT(ip1):long</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p>7</p></td>
<td align="left" valign="top"><p>8</p></td>
</tr>
</tbody>
</table>
</div>
<p>Can take any field type as input and the result is always a <code class="literal">long</code> not matter
the input type.</p>
<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_counts_are_approximate_2"></a>Counts are approximate<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/esql/aggregation-functions/count-distinct.asciidoc">edit</a></h3>
</div></div></div>
<p>Computing exact counts requires loading values into a set and returning its
size. This doesn&#8217;t scale when working on high-cardinality sets and/or large
values as the required memory usage and the need to communicate those
per-shard sets between nodes would utilize too many resources of the cluster.</p>
<p>This <code class="literal">COUNT_DISTINCT</code> function is based on the
<a href="https://static.googleusercontent.com/media/research.google.com/fr//pubs/archive/40671.pdf" class="ulink" target="_top">HyperLogLog++</a>
algorithm, which counts based on the hashes of the values with some interesting
properties:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
configurable precision, which decides on how to trade memory for accuracy,
</li>
<li class="listitem">
excellent accuracy on low-cardinality sets,
</li>
<li class="listitem">
fixed memory usage: no matter if there are tens or billions of unique values,
memory usage only depends on the configured precision.
</li>
</ul>
</div>
<p>For a precision threshold of <code class="literal">c</code>, the implementation that we are using requires
about <code class="literal">c * 8</code> bytes.</p>
<p>The following chart shows how the error varies before and after the threshold:</p>
<p><span class="image"><img src="images/cardinality_error.png" alt="cardinality error"></span></p>
<p>For all 3 thresholds, counts have been accurate up to the configured threshold.
Although not guaranteed, this is likely to be the case. Accuracy in practice depends
on the dataset in question. In general, most datasets show consistently good
accuracy. Also note that even with a threshold as low as 100, the error
remains very low (1-6% as seen in the above graph) even when counting millions of items.</p>
<p>The HyperLogLog++ algorithm depends on the leading zeros of hashed
values, the exact distributions of hashes in a dataset can affect the
accuracy of the cardinality.</p>
</div>

<div class="section">
<div class="titlepage"><div><div>
<h3 class="title"><a id="_precision_is_configurable"></a>Precision is configurable<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/elasticsearch/edit/main/docs/reference/esql/aggregation-functions/count-distinct.asciidoc">edit</a></h3>
</div></div></div>
<p>The <code class="literal">COUNT_DISTINCT</code> function takes an optional second parameter to configure the
precision discussed previously.</p>
<div class="pre_wrapper lang-esql merge styled">
<pre class="programlisting prettyprint lang-esql merge styled">FROM hosts
| STATS COUNT_DISTINCT(ip0, 80000), COUNT_DISTINCT(ip1, 5)</pre>
</div>
<div class="informaltable">
<table border="1" cellpadding="4px" class="monospaced styled">
<colgroup>
<col class="col_1"/>
<col class="col_2"/>
</colgroup>
<thead>
<tr>
<th align="left" valign="top">COUNT_DISTINCT(ip0,80000):long</th>
<th align="left" valign="top">COUNT_DISTINCT(ip1,5):long</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p>7</p></td>
<td align="left" valign="top"><p>9</p></td>
</tr>
</tbody>
</table>
</div>
</div>

</div>
<div class="navfooter">
<span class="prev">
<a href="esql-agg-count.html">« <code class="literal">COUNT</code></a>
</span>
<span class="next">
<a href="esql-agg-max.html"><code class="literal">MAX</code> »</a>
</span>
</div>
</div>
</body>
</html>
